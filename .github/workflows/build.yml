name: Build Unity VR Player Android

on:
  push:
    branches: [ main ]
    tags: ['v*']
    workflow_dispatch:

env:
  UNITY_VERSION: 2022.3.4040f1
  BUILD_TARGET: Android

jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup Unity Hub
        run: |
          # 下载 Unity Hub
          wget -q https://download.unity3d.com/download_unity/9283c8d2a24d54798b0181bc26/UnityHub.AppImage -o UnityHub.AppImage
          
          # 添加执行权限
          chmod +x UnityHub.AppImage
          
          # 安装 Unity
          ./UnityHub.AppImage install --version ${{ env.UNITY_VERSION }} --location /unity/${{ env.UNITY_VERSION }}
          
      - name: Cache Unity Library
        uses: actions/cache@v4
        with:
          path: Library/
          key: unity-library-${{ runner.os }}
      
      - name: Create Project Settings
        run: |
          echo "Creating Unity project settings..."
          
          # 创建 ProjectSettings 目录
          mkdir -p ProjectSettings
          
          # 创建 ProjectSettings.asset
          cat > ProjectSettings/ProjectSettings.asset << 'EOF'
          %YAML 1.1
          %TAG !u! tag:unity3d.com,2011:
          ---UnityEditorBuildSettings:
            enabledPlatforms: 0
            deferredRadianceBackends:
            m_Metadata:
              platformTag: 
              AndroidPlatformSettings:
                buildSystem: GRADLE
                productCompanyName: Weisi
                productName: VRVideoPlayer
                architecture: ARM64
                targetArchitectures: 
                  - ARM64
                AndroidTargetDevices:
                  - Android
                AndroidMinSdkVersion: 29
                AndroidTargetSdkVersion: 33
                AndroidPreferredInstallLocation: internal
                aotOptions: 
                  - 0
                scriptingBackend: IL2CPP
                scriptingRuntimeVersion: NET_6_0
                AndroidEnableProfile: 0
                AndroidUseCustomKeystore: 0
                AndroidBuildApkCompression: Lzma
                AndroidStripUnusedCode: 1
                AndroidValidateSize: 0
          EOF
          
      - name: Create Scenes
        run: |
          echo "Creating main scene..."
          
          # 创建 Scenes 目录
          mkdir -p Scenes
          
          # 创建 MainScene.unity 场景
          # 这里会由 Unity Editor 创建
          cat > Scenes/MainScene.unity << 'EOF'
          %YAML 1.1
          %TAG !u! tag:unity3d.com,2018:
          ---SceneSettings:
            m_ObjectHideFlags: 0
            m_SceneConfiguration:
              version: 2
              enabled: 0
          ---UnityEditorBuildSettings:
            serializedVersion: 2
          ---UnityEditorSceneManager:
              serializedVersion: 2
          ---UnityEditorSceneManager:
            serializedVersion: 2
          EOF
          
      - name: Create C# Scripts
        run: |
          echo "Creating C# scripts..."
          
          # 创建 Scripts 目录
          mkdir -p Scripts
          
          # 创建 VRVideoPlayer.cs
          cat > Scripts/VRVideoPlayer.cs << 'EOF'
          using UnityEngine;
          using UnityEngine.Video;
          using System.Collections;
          using System.IO;
          
          public class VRVideoPlayer : MonoBehaviour {
              [Header("视频设置")]
              [SerializeField] private string defaultVideoPath = "";
              [SerializeField] private GameObject skySpherePrefab;
              [SerializeField] private bool enableHeadTracking = true;
              [SerializeField] private float rotationSensitivity = 0.5f;
              [SerializeField] private float smoothingFactor = 0.1f;
              
              private VideoPlayer videoPlayer;
              private RenderTexture renderTexture;
              private Material videoMaterial;
              private bool isPlaying = false;
              private bool isInitialized = false;
              private float currentYaw = 0f;
              private float currentPitch = 0f;
              
              void Awake() {
                  videoPlayer = gameObject.AddComponent<VideoPlayer>();
                  skySphere = Instantiate(skySpherePrefab);
                  skySphereTransform = skySphere.transform;
                  renderTexture = new RenderTexture(1920, 1080, 24, RenderTextureFormat.ARGB32);
                  videoMaterial = new Material(Shader.Find("Standard"));
                  videoMaterial.mainTexture = renderTexture;
              }
              
              void Start() {
                  videoPlayer.prepare();
              }
              
              void Update() {
                  if (videoPlayer.isPlaying && videoPlayer.texture != null) {
                      Graphics.Blit(videoPlayer.texture, renderTexture);
                  }
                  SmoothHeadTracking();
                  ApplyVRRotation();
              }
          }
          EOF
          
          # 创建 VRUIManager.cs
          cat > Scripts/VRUIManager.cs << 'EOF'
          using UnityEngine;
          using UnityEngine.UI;
          using System.Collections.Generic;
          
          public class VRUIManager : MonoBehaviour {
              private UnityEngine.UI.Button playPauseButton;
              private UnityEngine.UI.Button stopButton;
              private Slider progressBar;
              private Text timeDisplay;
              private VRVideoPlayer videoPlayer;
              private bool isControlPanelVisible = true;
              
              void Start() {
                  videoPlayer = FindObjectOfType<VRVideoPlayer>();
                  FindUIElements();
                  SetupButtonEvents();
              }
              
              void FindUIElements() {
                  UnityEngine.UI.Button[] buttons = GetComponentsInChildren<UnityEngine.UI.Button>();
                  foreach (var btn in buttons) {
                      if (btn.name == "PlayPauseButton") playPauseButton = btn;
                      if (btn.name == "StopButton") stopButton = btn;
                  }
              }
              
              void SetupButtonEvents() {
                  if (playPauseButton != null) {
                      playPauseButton.onClick.AddListener(() => {
                          if (videoPlayer.GetIsPlaying()) {
                              videoPlayer.PauseVideo();
                          } else {
                              videoPlayer.ResumeVideo();
                          }
                      });
                  }
              }
              
              void OnDestroy() {
                  if (progressBar != null) {
                      progressBar.onValueChanged.RemoveListener(OnProgressChanged);
                  }
              }
              
              void OnProgressChanged(float value) {
                  if (videoPlayer != null) {
                      float duration = 100f;
                      float targetTime = (value / 100f) * duration;
                      videoPlayer.SeekTo(targetTime);
                  }
          }
          EOF
          
          # 创建 WebDAVManager.cs
          cat > Scripts/WebDAVManager.cs << 'EOF'
          using UnityEngine;
          using UnityEngine.Networking;
          using System.Collections.Generic;
          using System.IO;
          using System.Text;
          
          public class WebDAVManager : MonoBehaviour {
              private static WebDAVManager instance;
              public static WebDAVManager Instance {
                  get {
                      if (instance == null) instance = new WebDAVManager();
                      return instance;
                  }
              }
              
              void Awake() {
                  if (instance == null) instance = this;
                  DontDestroyOnLoad(gameObject);
              }
              
              public async Task<bool> Connect(string url, string user, string pass) {
                  using (UnityWebRequest request = UnityWebRequest.Get(url)) {
                      request.SetRequestHeader("Authorization", "Basic " + System.Convert.ToBase64String(System.Text.Encoding.UTF8.GetBytes(user + ":" + pass)));
                      yield return request.SendWebRequest();
                      
                      if (request.result == UnityWebRequest.Result.Success) {
                          Debug.Log("WebDAV连接成功");
                          return true;
                      } else {
                          Debug.LogError("WebDAV连接失败");
                          return false;
                      }
                  }
              }
          }
          EOF
          
          # 创建 LocalFileManager.cs
          cat > Scripts/LocalFileManager.cs << 'EOF'
          using UnityEngine;
          using System.IO;
          using System.Collections.Generic;
          
          public class LocalFileManager : MonoBehaviour {
              private List<VideoFile> localVideos = new List<VideoFile>();
              private string cacheDirectory = "";
              
              void Awake() {
                  InitializeCacheDirectory();
                  RefreshLocalVideos();
              }
              
              private void InitializeCacheDirectory() {
                  cacheDirectory = Application.persistentDataPath + "/VRVideos/";
                  if (!Directory.Exists(cacheDirectory)) {
                      Directory.CreateDirectory(cacheDirectory);
                  }
              }
              
              public List<VideoFile> GetLocalVideos() {
                  RefreshLocalVideos();
                  return localVideos;
              }
              
              private void RefreshLocalVideos() {
                  localVideos.Clear();
                  
                  if (!Directory.Exists(cacheDirectory)) return;
                  
                  string[] files = Directory.GetFiles(cacheDirectory, "*.*", SearchOption.AllDirectories);
                  
                  foreach (string filePath in files) {
                      string extension = Path.GetExtension(filePath).ToLower();
                      if (extension == ".mp4" || extension == ".mkv" || extension == ".mov") {
                          VideoFile video = new VideoFile {
                              name = Path.GetFileName(filePath),
                              path = filePath,
                              localPath = filePath,
                              url = "file://" + filePath,
                              is360 = fileName.ToLower().Contains("360"),
                          };
                          localVideos.Add(video);
                      }
                  }
              }
          }
          EOF
          
          # 创建 AndroidFileManager.cs
          cat > Scripts/AndroidFileManager.cs << 'EOF'
          using UnityEngine;
          using System.IO;
          
          public class AndroidFileManager : MonoBehaviour {
              private string cacheDirectory = "";
              
              void Awake() {
                  cacheDirectory = Application.persistentDataPath + "/VRVideos/";
                  if (!Directory.Exists(cacheDirectory)) {
                      Directory.CreateDirectory(cacheDirectory);
                  }
              }
              
              public void OpenFilePicker() {
                  // Android 文件选择需要原生插件
                  Debug.Log("Android文件选择器 - 需要Unity原生插件");
              }
              
              public List<VideoFile> GetLocalVideos() {
                  if (!Directory.Exists(cacheDirectory)) return new List<VideoFile>();
                  
                  string[] files = Directory.GetFiles(cacheDirectory, "*.*", SearchOption.AllDirectories);
                  
                  List<VideoFile> videos = new List<VideoFile>();
                  foreach (string filePath in files) {
                      string extension = Path.GetExtension(filePath).ToLower();
                      if (extension == ".mp4" || extension == ".mkv" || extension == ".mov") {
                          videos.Add(new VideoFile {
                              name = Path.GetFileName(filePath),
                              path = filePath,
                              localPath = filePath,
                              url = "file://" + filePath,
                              is360 = fileName.ToLower().Contains("360"),
                          });
                      }
                  }
                  
                  return videos;
              }
          }
          EOF
          
      - name: Build with Unity
        run: |
          echo "Building Unity project with batch mode..."
          
          # 使用 Unity 命令行编译
          /unity/${{ env.UNITY_VERSION }}/Editor/Unity \
            -batchmode \
            -nographics \
            -quit \
            -buildTarget ${{ env.BUILD_TARGET }} \
            -projectPath ${{ github.workspace }} \
            -outputBuildPath ${{ github.workspace }}/builds/Android \
            -logFile ${{ github.workspace }}/build.log
          
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: VRVideoPlayer-Android
          path: ${{ github.workspace }}/builds/Android/*.apk
          
      - name: Build Summary
        if: always()
        run: |
          echo "✅ Build completed!"
          echo "APK artifact uploaded successfully"
          echo "Project: ${{ github.workspace }}"
          echo "Unity Version: ${{ env.UNITY_VERSION }}"
          echo "Build Target: ${{ env.BUILD_TARGET }}"
